<section class="notifications-page">
  <header class="notifications-hero">
    <p class="eyebrow">{{ 'nav.notifications' | translate }}</p>
    <h1>{{ 'notifications.title' | translate }}</h1>
    <p>{{ 'notifications.subtitle' | translate }}</p>
  </header>

  <mat-card class="notifications-toolbar">
    <div>
      <h2>{{ 'notifications.inbox' | translate }}</h2>
      <p>{{ 'notifications.unreadSummary' | translate:{ count: unreadCount } }}</p>
    </div>

    <button
      mat-flat-button
      type="button"
      [disabled]="loading || markingAll || unreadCount === 0"
      (click)="markAllAsRead()">
      @if (markingAll) {
        <mat-progress-spinner diameter="16" mode="indeterminate"></mat-progress-spinner>
      }
      <span>{{ 'actions.markAllAsRead' | translate }}</span>
    </button>
  </mat-card>

  <mat-card class="notifications-preferences">
    <div class="notifications-preferences__content">
      <h3>{{ 'notifications.preferences.title' | translate }}</h3>
      <p>{{ 'notifications.preferences.hint' | translate }}</p>

      <label class="notifications-preferences__toggle">
        <input type="checkbox" [checked]="soundAlertsEnabled" (change)="onSoundAlertsChange($event)" />
        <span>{{ 'notifications.preferences.sound' | translate }}</span>
      </label>

      <label class="notifications-preferences__toggle">
        <input type="checkbox" [checked]="vibrationAlertsEnabled" (change)="onVibrationAlertsChange($event)" />
        <span>{{ 'notifications.preferences.vibration' | translate }}</span>
      </label>
    </div>

    <button
      mat-stroked-button
      type="button"
      [disabled]="!soundAlertsEnabled && !vibrationAlertsEnabled"
      (click)="testAlertCue()">
      {{ 'actions.testAlert' | translate }}
    </button>
  </mat-card>

  @if (loading) {
    <p class="state">{{ 'notifications.loading' | translate }}</p>
  }
  @if (successMessage) {
    <p class="success">{{ successMessage | translate }}</p>
  }
  @if (errorMessage) {
    <p class="error">{{ errorMessage | translate }}</p>
  }

  @if (!loading && !errorMessage && notifications.length === 0) {
    <section class="empty-state">
      {{ 'notifications.empty' | translate }}
    </section>
  }

  @if (!loading && notifications.length > 0) {
    <section class="notifications-list">
      @for (notification of notifications; track trackNotification($index, notification)) {
        <mat-card
          class="notification-card"
          [class.notification-card--read]="notification.isRead"
          >
          <div class="notification-card__head">
            <div>
              <h3>{{ notification.title }}</h3>
              <p>{{ notification.createdAtUtc | date:'dd/MM/yyyy HH:mm' }}</p>
            </div>
            <span class="status-chip" [class.status-chip--read]="notification.isRead">
              {{ (notification.isRead ? 'notifications.read' : 'notifications.unread') | translate }}
            </span>
          </div>
          <p class="notification-card__message">{{ notification.message }}</p>
          <div class="notification-card__actions">
            @if (notification.appointmentId) {
              <a
                mat-button
                [routerLink]="['/dashboard/appointments', notification.appointmentId, 'audit']">
                {{ 'actions.viewAudit' | translate }}
              </a>
            }
            @if (!notification.isRead) {
              <button
                mat-stroked-button
                type="button"
                [disabled]="markingAll || markingNotificationId === notification.userNotificationId"
                (click)="markNotificationAsRead(notification)">
                @if (markingNotificationId === notification.userNotificationId) {
                  <mat-progress-spinner diameter="16" mode="indeterminate"></mat-progress-spinner>
                }
                <span>{{ 'actions.markAsRead' | translate }}</span>
              </button>
            }
          </div>
        </mat-card>
      }
    </section>
  }
</section>
