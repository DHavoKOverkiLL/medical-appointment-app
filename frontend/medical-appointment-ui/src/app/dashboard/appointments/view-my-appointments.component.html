<section class="appointments-page">
  <header class="appointments-hero">
    <p class="appointments-eyebrow">{{ 'appointmentsMy.eyebrow' | translate }}</p>
    <h1>{{ 'appointmentsMy.title' | translate }}</h1>
    <p>{{ 'appointmentsMy.subtitle' | translate }}</p>

    <div class="appointments-actions">
      <a mat-flat-button routerLink="/dashboard/appointments/book">{{ 'actions.bookAppointment' | translate }}</a>
      <a mat-stroked-button routerLink="/dashboard/patient/calendar">{{ 'actions.openCalendar' | translate }}</a>
    </div>
  </header>

  <section class="appointments-metrics">
    <mat-card>
      <span>{{ 'metrics.upcoming' | translate }}</span>
      <strong>{{ upcomingCount }}</strong>
    </mat-card>
    <mat-card>
      <span>{{ 'metrics.pendingRequests' | translate }}</span>
      <strong>{{ pendingPostponeCount }}</strong>
    </mat-card>
    <mat-card>
      <span>{{ 'metrics.counterProposals' | translate }}</span>
      <strong>{{ counterProposalCount }}</strong>
    </mat-card>
  </section>

  @if (successMessage) {
    <p class="success">{{ successMessage | translate }}</p>
  }
  @if (loading && appointments.length > 0) {
    <p class="state">{{ 'state.loadingAppointments' | translate }}</p>
  }
  @if (errorMessage) {
    <p class="error">{{ errorMessage | translate }}</p>
  }

  @if (loading && appointments.length === 0) {
    <section class="app-skeleton-list" aria-hidden="true">
      @for (_ of skeletonRows; track $index) {
        <article class="app-skeleton-card">
          <div class="app-skeleton-line app-skeleton-line--title"></div>
          <div class="app-skeleton-line app-skeleton-line--meta"></div>
          <div class="app-skeleton-pills">
            <span class="app-skeleton-pill"></span>
            <span class="app-skeleton-pill"></span>
            <span class="app-skeleton-pill"></span>
          </div>
        </article>
      }
    </section>
  }

  @if (!loading && !errorMessage && appointments.length === 0) {
    <section class="empty-state">
      {{ 'appointmentsMy.empty' | translate }}
    </section>
  }

  @if (!loading && appointments.length > 0) {
    <section class="appointments-list">
      @for (appointment of appointments; track trackAppointment($index, appointment)) {
        <mat-card class="appointment-card">
          <div class="appointment-main">
            <div class="appointment-title">
              <h2>{{ appointment.doctorName }}</h2>
              <span [class]="getStatusClass(appointment)">
                {{ getStatusLabel(appointment) | translate }}
              </span>
            </div>
            <div class="appointment-meta">
              <span>{{ appointment.appointmentDateTime | date:'dd/MM/yyyy' }}</span>
              <span>{{ appointment.appointmentDateTime | date:'HH:mm' }}</span>
              <span>{{ appointment.clinicName }}</span>
              <span [class.appointment-past]="isPast(appointment)">
                {{ isPast(appointment) ? ('statuses.completed' | translate) : ('statuses.upcoming' | translate) }}
              </span>
            </div>
            @if (appointment.proposedDateTime) {
              <p class="appointment-extra">
                {{ 'common.proposed' | translate }}: {{ appointment.proposedDateTime | date:'dd/MM/yyyy HH:mm' }}
              </p>
            }
            @if (appointment.postponeReason) {
              <p class="appointment-extra">
                {{ 'common.reason' | translate }}: {{ appointment.postponeReason }}
              </p>
            }
            @if (appointment.cancellationReason) {
              <p class="appointment-extra">
                {{ 'common.cancelReason' | translate }}: {{ appointment.cancellationReason }}
              </p>
            }
            @if (appointment.doctorResponseNote && !isRejectedStatus(appointment.postponeRequestStatus)) {
              <p class="appointment-extra">
                {{ 'common.doctorNote' | translate }}: {{ appointment.doctorResponseNote }}
              </p>
            }
            @if (appointment.doctorResponseNote && isRejectedStatus(appointment.postponeRequestStatus)) {
              <section class="reject-reason-box">
                <strong>{{ 'statuses.rejectedByDoctor' | translate }}</strong>
                <p>{{ appointment.doctorResponseNote }}</p>
              </section>
            }
            @if (canRespondToCounterProposal(appointment)) {
              <div class="counter-response-actions">
                <button
                  mat-flat-button
                  class="button-with-spinner"
                  type="button"
                  [disabled]="actionSubmittingAppointmentId === appointment.appointmentId"
                  (click)="respondToCounterProposal(appointment, 'Accept')">
                  @if (actionSubmittingAppointmentId === appointment.appointmentId && actionDecision === 'Accept') {
                    <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                  }
                  <span>{{ 'actions.acceptCounterProposal' | translate }}</span>
                </button>
                <button
                  mat-stroked-button
                  class="button-with-spinner"
                  type="button"
                  [disabled]="actionSubmittingAppointmentId === appointment.appointmentId"
                  (click)="respondToCounterProposal(appointment, 'Reject')">
                  @if (actionSubmittingAppointmentId === appointment.appointmentId && actionDecision === 'Reject') {
                    <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                  }
                  <span>{{ 'actions.rejectCounterProposal' | translate }}</span>
                </button>
              </div>
            }
            @if (canCancelAppointment(appointment)) {
              <div class="counter-response-actions">
                <button
                  mat-stroked-button
                  class="button-with-spinner"
                  type="button"
                  [disabled]="actionSubmittingAppointmentId === appointment.appointmentId"
                  (click)="cancelAppointment(appointment)">
                  @if (actionSubmittingAppointmentId === appointment.appointmentId && actionDecision === 'Cancel') {
                    <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                  }
                  <span>{{ 'actions.cancelAppointment' | translate }}</span>
                </button>
              </div>
            }
            <div class="counter-response-actions">
              <a mat-button [routerLink]="['/dashboard/appointments', appointment.appointmentId, 'audit']">
                {{ 'actions.viewAudit' | translate }}
              </a>
            </div>
          </div>
        </mat-card>
      }
    </section>
  }
</section>
