<section class="doctor-consults">
  <header class="consults-hero">
    <p class="consults-eyebrow">{{ 'appointmentsDoctor.eyebrow' | translate }}</p>
    <h1>{{ 'appointmentsDoctor.title' | translate }}</h1>
    <p>{{ 'appointmentsDoctor.subtitle' | translate }}</p>

    <div class="consults-actions">
      <a mat-flat-button routerLink="/dashboard/doctor">{{ 'actions.backToDashboard' | translate }}</a>
    </div>
  </header>

  <section class="consults-metrics">
    <mat-card>
      <span>{{ 'metrics.upcomingConsults' | translate }}</span>
      <strong>{{ upcomingConsults.length }}</strong>
    </mat-card>
    <mat-card>
      <span>{{ 'metrics.pendingRequests' | translate }}</span>
      <strong>{{ pendingRequests.length }}</strong>
    </mat-card>
    <mat-card>
      <span>{{ 'metrics.awaitingPatientReply' | translate }}</span>
      <strong>{{ counterProposalsAwaitingPatient.length }}</strong>
    </mat-card>
  </section>

  @if (successMessage) {
    <p class="success">{{ successMessage | translate }}</p>
  }
  @if (loading && appointments.length > 0) {
    <p class="state">{{ 'state.loadingConsults' | translate }}</p>
  }
  @if (errorMessage) {
    <p class="error">{{ errorMessage | translate }}</p>
  }

  @if (loading && appointments.length === 0) {
    <section class="app-skeleton-list" aria-hidden="true">
      @for (_ of skeletonRows; track $index) {
        <article class="app-skeleton-card">
          <div class="app-skeleton-line app-skeleton-line--title"></div>
          <div class="app-skeleton-line app-skeleton-line--meta"></div>
          <div class="app-skeleton-pills">
            <span class="app-skeleton-pill"></span>
            <span class="app-skeleton-pill"></span>
            <span class="app-skeleton-pill"></span>
          </div>
        </article>
      }
    </section>
  }

  @if (!loading && !errorMessage && appointments.length === 0) {
    <section class="empty-state">
      {{ 'appointmentsDoctor.empty' | translate }}
    </section>
  }

  @if (!loading && pendingRequests.length > 0) {
    <section class="request-section">
      <h2>{{ 'appointmentsDoctor.pendingRequestsTitle' | translate }}</h2>
      @for (appointment of pendingRequests; track trackAppointment($index, appointment)) {
        <mat-card class="request-card">
          <div class="request-title">
            <strong>{{ appointment.patientName }}</strong>
            <span [class]="getStatusClass(appointment)">
              {{ getStatusLabel(appointment) | translate }}
            </span>
          </div>
          <p>{{ 'appointmentsDoctor.currentSlot' | translate }}: {{ appointment.appointmentDateTime | date:'dd/MM/yyyy HH:mm' }}</p>
          @if (appointment.proposedDateTime) {
            <p>
              {{ 'appointmentsDoctor.proposedSlot' | translate }}: {{ appointment.proposedDateTime | date:'dd/MM/yyyy HH:mm' }}
            </p>
          }
          @if (appointment.postponeReason) {
            <p class="request-reason">
              {{ 'common.reason' | translate }}: {{ appointment.postponeReason }}
            </p>
          }
          <div class="request-actions">
            <button
              mat-flat-button
              class="button-with-spinner"
              type="button"
              [disabled]="actionSubmitting"
              (click)="respondToPendingRequest(appointment.appointmentId)">
              @if (actionSubmitting && actionSubmittingMode === 'approve' && actionSubmittingAppointmentId === appointment.appointmentId) {
                <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
              }
              <span>{{ 'actions.approve' | translate }}</span>
            </button>
            <button
              mat-stroked-button
              type="button"
              [disabled]="actionSubmitting"
              (click)="openRejectRequest(appointment)">
              {{ 'actions.reject' | translate }}
            </button>
            <button
              mat-stroked-button
              type="button"
              [disabled]="actionSubmitting"
              (click)="openCounterProposal(appointment)">
              {{ 'actions.counterPropose' | translate }}
            </button>
          </div>
        </mat-card>
      }
    </section>
  }

  @if (!loading && counterProposalsAwaitingPatient.length > 0) {
    <section class="request-section">
      <h2>{{ 'appointmentsDoctor.awaitingCounterResponseTitle' | translate }}</h2>
      @for (appointment of counterProposalsAwaitingPatient; track trackAppointment($index, appointment)) {
        <mat-card class="request-card">
          <div class="request-title">
            <strong>{{ appointment.patientName }}</strong>
            <span [class]="getStatusClass(appointment)">
              {{ getStatusLabel(appointment) | translate }}
            </span>
          </div>
          <p>{{ 'appointmentsDoctor.currentSlot' | translate }}: {{ appointment.appointmentDateTime | date:'dd/MM/yyyy HH:mm' }}</p>
          @if (appointment.proposedDateTime) {
            <p>
              {{ 'appointmentsDoctor.counterProposedSlot' | translate }}: {{ appointment.proposedDateTime | date:'dd/MM/yyyy HH:mm' }}
            </p>
          }
          @if (appointment.doctorResponseNote) {
            <p class="request-reason">
              {{ 'common.note' | translate }}: {{ appointment.doctorResponseNote }}
            </p>
          }
        </mat-card>
      }
    </section>
  }

  @if (!loading && appointments.length > 0) {
    <section class="timeline-section">
      <h2>{{ 'appointmentsDoctor.timelineTitle' | translate }}</h2>
      @for (appointment of appointments; track trackAppointment($index, appointment)) {
        <mat-card class="consult-card">
          <div class="consult-title">
            <strong>{{ appointment.patientName }}</strong>
            <span [class]="getStatusClass(appointment)">
              {{ getStatusLabel(appointment) | translate }}
            </span>
          </div>
          <div class="consult-meta">
            <span>{{ appointment.appointmentDateTime | date:'dd/MM/yyyy' }}</span>
            <span>{{ appointment.appointmentDateTime | date:'HH:mm' }}</span>
          </div>
          @if (appointment.proposedDateTime) {
            <p class="consult-extra">
              {{ 'common.proposed' | translate }}: {{ appointment.proposedDateTime | date:'dd/MM/yyyy HH:mm' }}
            </p>
          }
          @if (appointment.postponeReason) {
            <p class="consult-extra">
              {{ 'common.reason' | translate }}: {{ appointment.postponeReason }}
            </p>
          }
          @if (appointment.cancellationReason) {
            <p class="consult-extra">
              {{ 'common.cancelReason' | translate }}: {{ appointment.cancellationReason }}
            </p>
          }
          @if (appointment.doctorResponseNote) {
            <p class="consult-extra">
              {{ 'common.doctorNote' | translate }}: {{ appointment.doctorResponseNote }}
            </p>
          }
          @if (canCancelAppointment(appointment)) {
            <div class="request-actions">
              <button
                mat-stroked-button
                class="button-with-spinner"
                type="button"
                [disabled]="actionSubmitting"
                (click)="cancelAppointment(appointment)">
                @if (actionSubmitting && actionSubmittingMode === 'cancel' && actionSubmittingAppointmentId === appointment.appointmentId) {
                  <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                }
                <span>{{ 'actions.cancelAppointment' | translate }}</span>
              </button>
            </div>
          }
          @if (canMarkAttendance(appointment)) {
            <div class="request-actions">
              <button
                mat-flat-button
                class="button-with-spinner"
                type="button"
                [disabled]="actionSubmitting"
                (click)="markAttendance(appointment, 'Completed')">
                @if (actionSubmitting && actionSubmittingMode === 'complete' && actionSubmittingAppointmentId === appointment.appointmentId) {
                  <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                }
                <span>{{ 'actions.markCompleted' | translate }}</span>
              </button>
              <button
                mat-stroked-button
                class="button-with-spinner"
                type="button"
                [disabled]="actionSubmitting"
                (click)="markAttendance(appointment, 'NoShow')">
                @if (actionSubmitting && actionSubmittingMode === 'noshow' && actionSubmittingAppointmentId === appointment.appointmentId) {
                  <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
                }
                <span>{{ 'actions.markNoShow' | translate }}</span>
              </button>
            </div>
          }
          <div class="request-actions">
            <a mat-button [routerLink]="['/dashboard/appointments', appointment.appointmentId, 'audit']">
              {{ 'actions.viewAudit' | translate }}
            </a>
          </div>
        </mat-card>
      }
    </section>
  }

  @if (activeRejectAppointmentId) {
    <div class="action-modal-backdrop" (click)="cancelRejectRequest()"></div>
  }
  @if (activeRejectAppointmentId) {
    <section class="action-modal action-modal--reject" (click)="$event.stopPropagation()">
      <header class="action-modal-header">
        <h3>{{ 'appointmentsDoctor.rejectModalTitle' | translate }}</h3>
        @if (rejectTargetAppointment) {
          <p>{{ 'common.patient' | translate }}: {{ rejectTargetAppointment.patientName }}</p>
        }
      </header>
      <form class="action-modal-form" [formGroup]="rejectForm" (ngSubmit)="submitRejectRequest()">
        <mat-form-field appearance="outline">
          <mat-label>{{ 'appointmentsDoctor.rejectReason' | translate }}</mat-label>
          <textarea matInput rows="3" maxlength="500" formControlName="reason"></textarea>
        </mat-form-field>
        <div class="reject-actions">
          <button mat-flat-button class="button-with-spinner" type="submit" [disabled]="rejectForm.invalid || actionSubmitting">
            @if (actionSubmitting && actionSubmittingMode === 'reject' && actionSubmittingAppointmentId === activeRejectAppointmentId) {
              <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
            }
            <span>{{ 'actions.confirmRejection' | translate }}</span>
          </button>
          <button mat-stroked-button type="button" [disabled]="actionSubmitting" (click)="cancelRejectRequest()">
            {{ 'common.cancel' | translate }}
          </button>
        </div>
      </form>
    </section>
  }

  @if (activeCounterAppointmentId) {
    <div class="action-modal-backdrop" (click)="cancelCounterProposal()"></div>
  }
  @if (activeCounterAppointmentId) {
    <section class="action-modal" (click)="$event.stopPropagation()">
      <header class="action-modal-header">
        <h3>{{ 'appointmentsDoctor.counterModalTitle' | translate }}</h3>
        @if (counterTargetAppointment) {
          <p>{{ 'common.patient' | translate }}: {{ counterTargetAppointment.patientName }}</p>
        }
      </header>
      <form class="action-modal-form" [formGroup]="counterForm" (ngSubmit)="submitCounterProposal()">
        <div class="counter-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'common.date' | translate }}</mat-label>
            <input matInput [matDatepicker]="counterModalDatePicker" formControlName="date" [min]="minDate" />
            <mat-datepicker-toggle matSuffix [for]="counterModalDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #counterModalDatePicker></mat-datepicker>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'common.timeSlot30' | translate }}</mat-label>
            <mat-select formControlName="time" [disabled]="loadingCounterSlots || availableCounterSlots.length === 0">
              @for (slot of availableCounterSlots; track slot) {
                <mat-option [value]="slot">
                  {{ slot }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        @if (loadingCounterSlots) {
          <p class="consult-extra">{{ 'appointmentsDoctor.messages.loadingSlots' | translate }}</p>
        }
        @if (!loadingCounterSlots && counterForm.value.date && availableCounterSlots.length === 0) {
          <p class="consult-extra">
            {{ 'appointmentsDoctor.messages.noSlots' | translate }}
          </p>
        }
        @if (!loadingCounterSlots && counterSlotsTimezone && availableCounterSlots.length > 0) {
          <p class="consult-extra">
            {{ 'appointmentsDoctor.messages.slotsTimezone' | translate:{ timezone: counterSlotsTimezone } }}
          </p>
        }
        <mat-form-field appearance="outline">
          <mat-label>{{ 'common.noteOptional' | translate }}</mat-label>
          <input matInput type="text" maxlength="500" formControlName="note" />
        </mat-form-field>
        <div class="counter-actions">
          <button mat-flat-button class="button-with-spinner" type="submit" [disabled]="counterForm.invalid || actionSubmitting">
            @if (actionSubmitting && actionSubmittingMode === 'counter' && actionSubmittingAppointmentId === activeCounterAppointmentId) {
              <mat-progress-spinner mode="indeterminate" diameter="16"></mat-progress-spinner>
            }
            <span>{{ 'actions.sendCounterProposal' | translate }}</span>
          </button>
          <button mat-stroked-button type="button" [disabled]="actionSubmitting" (click)="cancelCounterProposal()">
            {{ 'common.cancel' | translate }}
          </button>
        </div>
      </form>
    </section>
  }
</section>
