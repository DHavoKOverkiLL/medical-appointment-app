name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend:
    name: Backend (.NET)
    runs-on: ubuntu-latest
    env:
      DOTNET_SYSTEM_GLOBALIZATION_INVARIANT: "0"
    defaults:
      run:
        working-directory: backend/MedicalAppointment.Api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore MedicalAppointment.Api.sln

      - name: Build
        run: dotnet build MedicalAppointment.Api.sln --configuration Release --no-restore

      - name: Test
        shell: pwsh
        run: |
          dotnet test MedicalAppointment.Api.sln --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory TestResults --logger "trx;LogFileName=test-results.trx"
          $testExitCode = $LASTEXITCODE

          if ($testExitCode -ne 0) {
            $trx = Get-ChildItem -Path TestResults -Recurse -Filter test-results.trx | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            if ($trx) {
              [xml]$trxXml = Get-Content -Path $trx.FullName
              $failedResults = @($trxXml.TestRun.Results.UnitTestResult | Where-Object { $_.outcome -eq "Failed" })
              $testDefinitions = @($trxXml.TestRun.TestDefinitions.UnitTest)

              foreach ($failed in $failedResults) {
                $definition = $testDefinitions | Where-Object { $_.id -eq $failed.testId } | Select-Object -First 1
                $testName = if ($definition -and $definition.TestMethod) {
                  "$($definition.TestMethod.className).$($definition.TestMethod.name)"
                } else {
                  [string]$failed.testName
                }

                $message = [string]$failed.Output.ErrorInfo.Message
                if ([string]::IsNullOrWhiteSpace($message)) {
                  $message = "Test failed. See backend-test-results artifact for details."
                }

                $singleLineMessage = $message.Replace("`r", " ").Replace("`n", " ")
                if ($singleLineMessage.Length -gt 300) {
                  $singleLineMessage = $singleLineMessage.Substring(0, 300) + "..."
                }

                Write-Host "::error title=Failed test::$testName - $singleLineMessage"
              }
            } else {
              Write-Host "::error::dotnet test failed and test-results.trx was not found."
            }
          }

          exit $testExitCode

      - name: Enforce backend coverage floor
        shell: pwsh
        run: |
          $coverageFile = Get-ChildItem -Path TestResults -Recurse -Filter coverage.cobertura.xml | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $coverageFile) {
            throw "Coverage file not found under TestResults."
          }

          [xml]$coverageXml = Get-Content -Path $coverageFile.FullName
          $rawLineRate = [math]::Round(([double]$coverageXml.coverage.'line-rate') * 100, 2)
          $rawBranchRate = [math]::Round(([double]$coverageXml.coverage.'branch-rate') * 100, 2)

          $excludePattern = 'MedicalAppointment\.Infrastructure[\\/]Migrations[\\/]|MedicalAppointment\.Api[\\/]obj[\\/]'
          $lineTotal = 0
          $lineCovered = 0
          $branchTotal = 0
          $branchCovered = 0

          foreach ($package in @($coverageXml.coverage.packages.package)) {
            foreach ($class in @($package.classes.class)) {
              $filename = [string]$class.filename
              if ($filename -match $excludePattern) {
                continue
              }

              foreach ($line in @($class.lines.line)) {
                $lineTotal++
                if ([int]$line.hits -gt 0) {
                  $lineCovered++
                }

                if ([string]$line.branch -eq 'true') {
                  $conditionCoverage = [string]$line.'condition-coverage'
                  if ($conditionCoverage -match '\((\d+)/(\d+)\)') {
                    $branchCovered += [int]$matches[1]
                    $branchTotal += [int]$matches[2]
                  }
                }
              }
            }
          }

          if ($lineTotal -eq 0) {
            throw "Filtered coverage produced zero executable lines."
          }

          $lineRate = [math]::Round(($lineCovered * 100.0) / $lineTotal, 2)
          $branchRate = if ($branchTotal -gt 0) {
            [math]::Round(($branchCovered * 100.0) / $branchTotal, 2)
          } else {
            0
          }

          $minLineRate = 55
          $minBranchRate = 40

          Write-Host "Backend raw coverage line-rate: $rawLineRate%"
          Write-Host "Backend raw coverage branch-rate: $rawBranchRate%"
          Write-Host "Backend non-migration coverage line-rate: $lineRate% ($lineCovered/$lineTotal)"
          Write-Host "Backend non-migration coverage branch-rate: $branchRate% ($branchCovered/$branchTotal)"

          if ($lineRate -lt $minLineRate -or $branchRate -lt $minBranchRate) {
            throw "Backend non-migration coverage below floor (line: $lineRate/$minLineRate, branch: $branchRate/$minBranchRate)."
          }

      - name: Upload backend test and coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/MedicalAppointment.Api/TestResults
          if-no-files-found: warn

  frontend:
    name: Frontend (Angular)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/medical-appointment-ui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/medical-appointment-ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1

      - name: Export Chrome path
        run: echo "CHROME_BIN=${{ steps.setup-chrome.outputs.chrome-path }}" >> $GITHUB_ENV

      - name: Test
        run: npm run test:ci:coverage

      - name: Upload frontend coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/medical-appointment-ui/coverage
          if-no-files-found: warn
